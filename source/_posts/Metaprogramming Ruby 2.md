---
title: ã€ŠRubyå…ƒç¼–ç¨‹ã€‹
date: 2021-05-04 07:03:32
tags: ä¹¦ç±
categories: ruby
cover: /img/ruby.png
---

# å…ƒè¿™ä¸ªå­—çœ¼

# å¯¹è±¡æ¨¡å‹

Rubyçš„ä¸–ç•Œé™¤äº†å¯¹è±¡ï¼Œè¿˜æœ‰å…¶ä»–çš„è¯­è¨€æ„ä»¶ï¼Œæ¯”å¦‚classï¼Œmoduleï¼Œinstance variableç­‰ï¼Œå…ƒç¼–ç¨‹æ“ä½œçš„å°±æ˜¯è¿™äº›è¯­è¨€æ„ä»¶ã€‚

æ‰€æœ‰è¿™äº›è¯­è¨€æ„ä»¶å­˜åœ¨çš„ç³»ç»Ÿç§°ä¹‹ä¸ºå¯¹è±¡æ¨¡å‹ã€‚

## æ‰“å¼€ç±»

```shell
2.7.2 :011 > def to_alphanumeric(s)
2.7.2 :012 >   s.gsub(/[^\w\s]/,'')
2.7.2 :013 > end
 => :to_alphanumeric 
2.7.2 :014 > to_alphanumeric("hello, %% world")
 => "hello  world" 
```

**æ›´å¥½çš„æ–¹æ³•æ˜¯è®©å­—ç¬¦ä¸²æœ¬èº«æ¥åšè¿™ç§è½¬æ¢**

**å¯ä»¥å»Stringç±»æ¤å…¥to_alphanumericæ–¹æ³•**

### ç±»å®šä¹‰æ­ç§˜

Rubyä¸­ï¼Œå®šä¹‰ç±»çš„è¯­å¥å’Œå…¶ä»–è¯­å¥æ²¡æœ‰æœ¬è´¨åŒºåˆ«

```shell
2.7.2 :015 > 3.times do
2.7.2 :016 >   class C
2.7.2 :017 >     puts "Hello Longbiu"
2.7.2 :018 >   end
2.7.2 :019 > end
Hello Longbiu
Hello Longbiu
Hello Longbiu
 => 3 
```

Rubyçš„classå…³é”®å­—æ›´åƒæ˜¯ä¸€ä¸ªä½œç”¨åŸŸæ“ä½œç¬¦ï¼Œè€Œä¸æ˜¯ç±»å‹å£°æ˜è¯­å¥ã€‚classå…³é”®å­—çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æŠŠä½ å¸¦åˆ°ç±»çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè®©ä½ å¯ä»¥åœ¨é‡Œé¢å®šä¹‰æ–¹æ³•ã€‚

**é‡æ–°æ‰“å¼€å·²ç»å­˜åœ¨çš„ç±»å¹¶å¯¹ä¹‹è¿›è¡ŒåŠ¨æ€ä¿®æ”¹â€”â€”æ‰“å¼€ç±»ï¼ˆopen classï¼‰**

### æ‰“å¼€ç±»çš„é—®é¢˜

```shell
2.7.2 :005 > [].methods.grep /^re/
 => [:reject!, :repeated_permutation, :repeated_combination, :reject, :reverse_each, :replace, :reverse, :reverse!, :reduce, :remove_instance_variable, :respond_to?] 
```

æ–¹æ³•åå†²çªæ—¶å¯èƒ½ä¼šå‡ºç°bugï¼Œè¿™ç§ç²—æš´çš„ä¿®æ”¹ç±»çš„æ–¹æ³•ä¹Ÿå«åšâ€”â€”**çŒ´å­è¡¥ä¸(Monkeypatch)**

ä¸€èˆ¬æ¥è¯´ï¼Œæ·»åŠ æ–°æ–¹æ³•æ¯”ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•å®‰å…¨ã€‚

## ç±»çš„çœŸç›¸

### å¯¹è±¡ä¸­æœ‰ä»€ä¹ˆ

![image-20210521101716315](/img/Metaprogramming/image-20210521101716315.png)

å‡å¦‚è¯´ï¼Œmy_method()æ˜¯MyClassçš„ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œè¿™å°±æ„å‘³ç€è¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨MyClassä¸­ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªMyClassçš„å®ä¾‹æ‰èƒ½è°ƒç”¨å®ƒã€‚

åŒä¸€ä¸ªç±»çš„å¯¹è±¡å…±äº«åŒæ ·çš„æ–¹æ³•ï¼Œä½†ä¸å…±äº«å®ä¾‹å˜é‡ã€‚

### ç±»çš„çœŸç›¸

ç±»æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ã€‚

å…¶ä»–è¯­è¨€åªå…è®¸ä½ è¯»å–ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œè€ŒRubyå…è®¸ä½ åœ¨è¿è¡Œæ—¶ä¿®æ”¹è¿™äº›ä¿¡æ¯ã€‚

**Rubyçš„ç±»ç»§æ‰¿è‡ªå®ƒçš„è¶…ç±»**

```shell
2.7.2 :006 > Array.superclass
 => Object 
2.7.2 :007 > Object.superclass
 => BasicObject 
2.7.2 :008 > BasicObject.superclass
 => nil 
2.7.2 :009 > Class.superclass
 => Module 
```

Rubyä¸­ï¼Œç±»ä¸æ¨¡å—è¿™ä¸¤ä¸ªæ¦‚å¿µååˆ†æ¥è¿‘ï¼Œä¿ç•™è¿™ä¸¤ä¸ªæ¦‚å¿µçš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†è·å¾—ä»£ç çš„æ¸…æ™°æ€§ã€‚

æŠŠè‡ªå·±çš„ä»£ç includeåˆ°åˆ«çš„ä»£ç â€”â€”Module

å¸Œæœ›æŸæ®µä»£ç è¢«å®ä¾‹åŒ–æˆ–è¢«ç»§æ‰¿â€”â€”Class

![image-20210521103307143](/img/Metaprogramming/image-20210521103307143.png)

```shell
2.7.2 :010 > class MyClass;
2.7.2 :011 > end
 => nil 
2.7.2 :012 > obj1 = MyClass.new
 => #<MyClass:0x00007f8fa4353dc0> 
2.7.2 :013 > obj2=MyClass.new
 => #<MyClass:0x00007f8fa43f14d0> 
2.7.2 :014 > MyClass.superclass
 => Object 
2.7.2 :016 > Class.new(MyClass)
 => #<Class:0x00007f8fa42d7608> 
2.7.2 :017 > Class.new(MyClass).superclass
 => MyClass 
```

### å¸¸é‡

ä»»ä½•ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„å¼•ç”¨(åŒ…æ‹¬ç±»åå’Œæ¨¡å—å)éƒ½æ˜¯å¸¸é‡ã€‚

Rubyä¸­ï¼Œå¸¸é‡å’Œå˜é‡çš„åŒºåˆ«åœ¨äºå®ƒä»¬çš„scopeä¸åŒã€‚

```shell
2.7.2 :018 > module MyModule
2.7.2 :019 >   MyConstant = "A"
2.7.2 :020 >   class MyClass
2.7.2 :021 >     MyConstant = "B"
2.7.2 :022 >   end
2.7.2 :023 > end
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Moduleæ¥ç»„ç»‡å¸¸é‡

### å¯¹è±¡å’Œç±»çš„å°ç»“

|      | æè¿°                                       |
| ---- | ------------------------------------------ |
| å¯¹è±¡ | ä¸€ç»„å®ä¾‹å˜é‡+æŒ‡å‘å…¶ç±»çš„å¼•ç”¨                |
| ç±»   | ä¸€ä¸ªå¯¹è±¡+ä¸€ç»„å®ä¾‹æ–¹æ³•+å¯¹å…¶superclassçš„å¼•ç”¨ |

```ruby
module Bookworm
	class Text
```

## ç¼ºå¤±çš„è¿æ¥çº¿

```shell
2.7.2 :026 > Object.class
 => Class 
2.7.2 :027 > Module.superclass
 => Object 
2.7.2 :028 > Class.class
 => Class 
```

## è°ƒç”¨æ–¹æ³•æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

1. **æ–¹æ³•æŸ¥æ‰¾**
2. **æ‰§è¡Œæ–¹æ³•**

### æ–¹æ³•æŸ¥æ‰¾

è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å‰ï¼ŒRubyä¼šåœ¨å¯¹è±¡çš„ç±»ä¸­æŸ¥æ‰¾é‚£ä¸ªæ–¹æ³•

**ä¸¤ä¸ªæ¦‚å¿µï¼šreceiver+ancestors chain**

receiverå°±æ˜¯ä½ è°ƒç”¨æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡

**Rubyé¦–å…ˆåœ¨æ¥å—è€…çš„ç±»ä¸­æŸ¥æ‰¾ï¼Œç„¶åé¡ºç€ç¥–å…ˆé“¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•ä¸ºæ­¢**

```shell
2.7.2 :037 > class MyClass
2.7.2 :038 >   def my_method;
2.7.2 :039 >     'my_method()';
2.7.2 :040 >   end
2.7.2 :041 > end
 => :my_method 
2.7.2 :042 > class MySubclass < MyClass
2.7.2 :043 > end
 => nil 
2.7.2 :044 > obj = MySubclass.new
 => #<MySubclass:0x00007f8fa44b33c8> 
2.7.2 :045 > obj.my_method()
 => "my_method()" 
```

**"å‘å³ä¸€æ­¥ï¼Œå†å‘ä¸Š"â€”â€”å…ˆå‘å³ä¸€æ­¥æ¥åˆ°æ¥æ”¶è€…æ‰€åœ¨çš„ç±»ï¼Œç„¶åæ²¿ç€ç¥–å…ˆé“¾å‘ä¸ŠæŸ¥æ‰¾ã€‚**

**æ¨¡å—ä¸æ–¹æ³•æŸ¥æ‰¾**

```shell
2.7.2 :046 > module M1
2.7.2 :047 >   def my_method
2.7.2 :048 >     "M1#my_method()"
2.7.2 :049 >   end
2.7.2 :050 > end
 => :my_method 
2.7.2 :051 > class C
2.7.2 :052 >   include M1
2.7.2 :053 > end
 => C 
2.7.2 :054 > class D < C;
2.7.2 :055 > end
 => nil 
2.7.2 :056 > D.ancestors
 => [D, C, M1, Object, JSON::Ext::Generator::GeneratorMethods::Object, Kernel, BasicObject] 
```

ä½¿ç”¨prependæ–¹æ³•ï¼Œå¯ä»¥æŠŠmoduleæ’å…¥ancestors chainä¸­åŒ…å«å®ƒçš„è¯¥ç±»çš„ä¸‹æ–¹ï¼Œè€Œä¸æ˜¯åƒincludeæ–¹æ³•é‚£æ ·æ’å…¥åˆ°ä¸Šæ–¹ã€‚

```shell
2.7.2 :057 > class C2
2.7.2 :058 >   prepend M1
2.7.2 :059 > end
 => C2 
2.7.2 :060 > class D2 < C2;
2.7.2 :061 > end
 => nil 
2.7.2 :062 > D2.ancestors
 => [D2, M1, C2, Object, JSON::Ext::Generator::GeneratorMethods::Object, Kernel, BasicObject] 
```

**å¤šé‡åŒ…å«**

```shell
2.7.2 :063 > module M1;
2.7.2 :064 > end
 => nil 
2.7.2 :065 > module M2
2.7.2 :066 >   include M1
2.7.2 :067 > end
 => M2 
2.7.2 :068 > module M3
2.7.2 :069 >   prepend M1
2.7.2 :070 >   include M2
2.7.2 :071 > end
 => M3 
2.7.2 :072 > M3.ancestors
 => [M1, M3, M2] 
```

å¦‚æœè¯¥moduleå·²ç»å­˜åœ¨äºç¥–å…ˆé“¾ä¸­ï¼Œé‚£ä¹ˆRubyä¼šæ‚„æ‚„å¿½ç•¥è¿™ä¸ªincludeæˆ–prependæŒ‡ä»¤ã€‚

**Kernelæ¨¡å—**

printæ–¹æ³•å…¶å®æ˜¯Kernelæ¨¡å—çš„ç§æœ‰å®ä¾‹æ–¹æ³•

```shell
2.7.2 :075 > Kernel.private_instance_methods.grep(/^pr/)
 => [:proc, :printf, :print] 
```

Objectç±»åŒ…å«äº†kernelæ¨¡å—ï¼Œæ‰€ä»¥æ— è®ºå“ªä¸ªå¯¹è±¡éƒ½å¯ä»¥éšæ„è°ƒç”¨Kernelæ¨¡å—çš„æ–¹æ³•ã€‚

**å†…æ ¸æ–¹æ³•**â€”â€”ç»™Kernelæ¨¡å—å¢åŠ ä¸€ä¸ªæ–¹æ³•

### æ‰§è¡Œæ–¹æ³•

å½“å‰å¯¹è±¡ç”¨selfè¡¨ç¤ºï¼Œå› æ­¤å¯ä»¥ç”¨selfå…³é”®å­—æ¥å¯¹ä»–è¿›è¡Œè®¿é—®ã€‚ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå¯¹è±¡èƒ½å……å½“å½“å‰å¯¹è±¡ï¼Œè€Œä¸”æ²¡æœ‰å“ªä¸ªå¯¹è±¡å¯ä»¥é•¿æœŸå……å½“æ­¤è§’è‰²ã€‚

**é¡¶å±‚ä¸Šä¸‹æ–‡â€”â€”top level context**

å¯¹è±¡mainæœ‰æ—¶è¢«ç§°ä¸ºé¡¶å±‚ä¸Šä¸‹æ–‡----æ­¤æ—¶å¼€å‘è€…å¤„åœ¨å †æ ˆçš„é¡¶å±‚ï¼Œè¦æ²¡è¿˜æ²¡æœ‰è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼Œè¦ä¹ˆè°ƒç”¨çš„æ–¹æ³•å·²ç»è¿”å›ã€‚

```shell
2.7.2 :079 > self
 => main 
2.7.2 :080 > self.class
 => Object 
```

åœ¨ç±»å’Œæ¨¡å—å®šä¹‰ä¹‹ä¸­ï¼Œselfçš„è§’è‰²ç”±è¿™ä¸ªç±»æˆ–è€…æ¨¡å—æœ¬èº«æ‹…ä»»ã€‚

### ç»†åŒ–

ç»†åŒ–è§£å†³çš„é—®é¢˜æ˜¯ï¼šè§£å†³ç ´åæ€§çš„çŒ´å­è¡¥ä¸

**ç»†åŒ–**ç”¨æ³•å¦‚ä¸‹ï¼š

```shell
2.7.2 :081 > module StringExtensions
2.7.2 :082 >   refine String do
2.7.2 :083 >     def to_alphanumeric
2.7.2 :084 >       gsub(/[^\w\s]/,'')
2.7.2 :085 >     end
2.7.2 :086 >   end
2.7.2 :087 > end
 => #<refinement:String@StringExtensions>
```

ç»†åŒ–åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ç”Ÿæ•ˆï¼Œä¸ºäº†ä½¿ç»†åŒ–ç”Ÿæ•ˆï¼Œå¿…é¡»è°ƒç”¨usingæ–¹æ³•ã€‚

```shell
2.7.2 :081 > module StringExtensions
2.7.2 :082 >   refine String do
2.7.2 :083 >     def to_alphanumeric
2.7.2 :084 >       gsub(/[^\w\s]/,'')
2.7.2 :085 >     end
2.7.2 :086 >   end
2.7.2 :087 > end
 => #<refinement:String@StringExtensions> 
2.7.2 :088 > module StringStuff
2.7.2 :089 >   using StringExtensions
2.7.2 :090 >   "my_string..".to_alphanumeric
2.7.2 :091 > end
 => "my_string" 
2.7.2 :092 > "my_string...##".to_alphanumeric
Traceback (most recent call last):
```

ç»†åŒ–åªåœ¨ä¸¤ç§åœºåˆæœ‰æ•ˆï¼šrefineä»£ç å†…éƒ¨ï¼Œä»usingè¯­å¥çš„ä½ç½®å¼€å§‹åˆ°æ¨¡å—ç»“æŸã€‚

ç»†åŒ–å¹¶éå…¨å±€æ€§çš„ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¸¦æ¥ç±»æ‰€å…·æœ‰çš„é—®é¢˜ï¼Œå¯ä»¥è®©ç»†åŒ–åªä½œç”¨åœ¨ä½ å¸Œæœ›ç”Ÿæ•ˆçš„åœ°æ–¹ã€‚

## æ··ä¹±çš„æ¨¡å—

## å¯¹è±¡æ¨¡å‹å°ç»“

- å¯¹è±¡ç”±ä¸€ç»„å®ä¾‹å˜é‡å’Œç±»çš„å¼•ç”¨ç»„æˆã€‚
- å¯¹è±¡çš„æ–¹æ³•å­˜åœ¨äºå¯¹è±¡æ‰€å±çš„ç±»ä¸­ï¼ˆå¯¹ç±»æ¥è¯´æ˜¯å®ä¾‹æ–¹æ³•ï¼‰ã€‚ç±»æœ¬èº«æ˜¯Classç±»çš„å¯¹è±¡ã€‚ç±»çš„åå­—åªæ˜¯ä¸€ä¸ªå¸¸é‡ã€‚
- Classç±»æ˜¯Moduleçš„å­ç±»ã€‚ä¸€ä¸ªæ¨¡å—åŸºæœ¬ä¸Šå°±æ˜¯ç”±ä¸€ç»„æ–¹æ³•ç»„æˆçš„åŒ…ã€‚ç±»é™¤äº†å…·æœ‰æ¨¡å—çš„ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¢«å®ä¾‹åŒ–ï¼ˆä½¿ç”¨newæ–¹æ³•ï¼‰ ï¼Œæˆ–è€…æŒ‰ä¸€å®šçš„å±‚æ¬¡ç»“æ„æ¥ç»„ç»‡ï¼ˆä½¿ç”¨superclassæ–¹æ³•ï¼‰ã€‚
- å¸¸é‡åƒæ–‡ä»¶ç³»ç»Ÿä¸€æ ·ï¼Œæ˜¯æŒ‰ç…§æ ‘å½¢ç»“æ„ç»„ç»‡çš„ã€‚å…¶ä¸­ï¼Œæ¨¡å—å’Œç±»çš„åå­—æ‰®æ¼”ç›®å½•çš„è§’è‰²ï¼Œå…¶ä»–æ™®é€šçš„å¸¸é‡åˆ™æ‰®æ¼”æ–‡ä»¶çš„è§’è‰²ã€‚
- æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªç¥–å…ˆé“¾ï¼Œè¿™ä¸ªé“¾ä»æ¯ä¸ªç±»è‡ªå·±å¼€å§‹ï¼Œå‘ä¸Šç›´åˆ°Basicobjectç»“æŸã€‚
- è°ƒç”¨æ–¹æ³•æ—¶ï¼Œ Rubyé¦–å…ˆå‘å³æ‰¾åˆ°æ¥æ”¶è€…æ‰€å±çš„ç±»ï¼Œç„¶åå‘ä¸ŠæŸ¥æ‰¾ç¥–å…ˆé“¾ï¼Œç›´åˆ°æ‰¾åˆ°è¯¥æ–¹æ³•æˆ–åˆ°è¾¾é“¾çš„é¡¶ç«¯ä¸ºæ­¢ã€‚
- åœ¨ç±»ä¸­åŒ…å«ä¸€ä¸ªæ¨¡å—ï¼ˆä½¿ç”¨includeæ–¹æ³•ï¼‰æ—¶ï¼Œè¿™ä¸ªæ¨¡å—ä¼šè¢«æ’å…¥ç¥–å…ˆé“¾ä¸­ï¼Œä½ç½®å°±åœ¨ç±»çš„æ­£ä¸Šæ–¹ï¼›è€Œä½¿ç”¨prependæ–¹æ³•åŒ…å«ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œè¿™ä¸ªæ¨¡å—ä¹Ÿä¼šè¢«æ’å…¥ç¥–å…ˆé“¾ä¸­ï¼Œä½ç½®åœ¨ç±»çš„æ­£ä¸‹æ–¹ã€‚
- è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œæ¥æ”¶è€…ä¼šæ‰®æ¼”selfçš„è§’è‰²ã€‚
- å®šä¹‰ä¸€ä¸ªæ¨¡å—ï¼ˆæˆ–ç±»ï¼‰æ—¶ï¼Œè¯¥æ¨¡å—ä¼šæ‰®æ¼”selfçš„è§’è‰²ã€‚å®ä¾‹å˜é‡æ°¸è¿œè¢«è®¤å®šä¸ºselfçš„å®ä¾‹å˜é‡ã€‚
- ä»»ä½•æ²¡æœ‰æ˜ç¡®æŒ‡å®šæ¥æ”¶è€…çš„æ–¹æ³•è°ƒç”¨ï¼Œéƒ½å½“åšæ˜¯è°ƒç”¨selfçš„æ–¹æ³•ã€‚
- ç»†åŒ–å°±åƒåœ¨åŸæ¥çš„ç±»ä¸Šæ·»åŠ äº†ä¸€å—è¡¥ä¸ï¼Œè€Œä¸”å®ƒä¼šè¦†ç›–æ­£å¸¸çš„æ–¹æ³•æŸ¥æ‰¾ã€‚æ­¤å¤–ï¼Œç»†åŒ–åªåœ¨ç¨‹åºçš„éƒ¨åˆ†åŒºåŸŸç”Ÿæ•ˆï¼šä»usingè¯­å¥çš„ä½ç½®å¼€å§‹ï¼Œç›´åˆ°æ¨¡å—ç»“æŸï¼Œæˆ–è€…ç›´åˆ°æ–‡ä»¶ç»“æŸã€‚

# æ–¹æ³•

**static type checking**

Javaâ€”â€”Javaçš„ç¼–è¯‘å™¨ä¼šæ§åˆ¶ä»£ç ä¹‹é—´çš„äº¤è°ˆï¼Œå¯¹äºæ¯ä¸€æ¬¡æ–¹æ³•çš„è°ƒç”¨ï¼Œç¼–è¯‘å™¨éƒ½ä¼šæ£€æŸ¥æ¥å—å¯¹è±¡æ˜¯å¦æœ‰ä¸€ä¸ªåŒ¹é…çš„æ–¹æ³•ï¼Œè¿™å°±å«åšâ€”â€”**é™æ€ç±»å‹æ£€æŸ¥**

æ‰€ä»¥Javaä¹Ÿå«åšé™æ€è¯­è¨€

**åŠ¨æ€è¯­è¨€åŒ…æ‹¬Python&Ruby**

åœ¨æŸä¸ªå¯¹è±¡ä¸Šè°ƒç”¨ç‰¹å®šçš„æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿä¸ä¼šå‘å‡ºè­¦å‘Šï¼Œç›´åˆ°çœŸæ­£çš„è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæç¤ºæ— æ³•å“åº”è°ƒç”¨ã€‚

## ä»£ç ç¹å¤çš„é—®é¢˜

###  è€ç³»ç»Ÿ

```text
DSç±»ä¸‹é¢æœ‰å¾ˆå¤šå¾ˆå¤šæ–¹æ³•ï¼éƒ½æ˜¯æ‹¿å–å¯¹åº”ä¿¡æ¯çš„ï¼Œçœ‹èµ·æ¥å°±å¾ˆç¹å¤çš„æ ·å­ï¼
```

### ä»£ç çš„ä¼˜é›…åŒ–ğŸ¶

**åŠ¨æ€æ–¹æ³•**

**method missing**

## åŠ¨æ€æ–¹æ³•

è°ƒç”¨ä¸€ä¸ªæ–¹æ³•â€”â€”ç»™ä¸€ä¸ªå¯¹è±¡å‘é€ä¸€ä¸ªæ¶ˆæ¯

### åŠ¨æ€è°ƒç”¨æ–¹æ³•

```ruby
2.7.2 :008 > class MyClass
2.7.2 :009 >   def my_method(my_arg)
2.7.2 :010 >     my_arg * 2
2.7.2 :011 >   end
2.7.2 :012 > end
 => :my_method 
2.7.2 :013 > obj = MyClass
 => MyClass 
2.7.2 :014 > obj = MyClass.new
 => #<MyClass:0x00007f8d721c8cc8> 
2.7.2 :015 > obj.send(:my_method,3)
 => 6 
2.7.2 :016 > obj.my_method(3)
 => 6 
```

**sendæ–¹æ³•é‡Œæ‰€è°ƒç”¨çš„æ–¹æ³•æˆä¸ºäº†å‚æ•°**

**Symbol**æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œ&ï¼Œç‰¹åˆ«é€‚åˆç”¨æ¥è¡¨ç¤ºæ–¹æ³•åã€‚

### åŠ¨æ€å®šä¹‰æ–¹æ³•

```ruby
2.7.2 :001 > class MyClass
2.7.2 :002 >   define_method :my_method do | my_arg|
2.7.2 :003 >   	my_arg*3
2.7.2 :004 >   end
2.7.2 :005 > end
 => :my_method 
2.7.2 :006 > obj = MyClass.new
 => #<MyClass:0x00007f8d6f67a990> 
2.7.2 :007 > obj.my_method(2)
 => 6 
```

è¿™ç§åœ¨è¿è¡Œæ—¶å®šä¹‰æ–¹æ³•çš„æŠ€æœ¯ç§°ä¸ºåŠ¨æ€æ–¹æ³•â€”â€”**Dynamic Method**

### é‡æ„Computerç±»

æ ¸å¿ƒå°±æ˜¯æ¥æ”¶String || Symbol ä½œä¸ºå‚æ•°ï¼Œå¹¶è°ƒç”¨æ–¹æ³•ã€‚

## method_missingæ–¹æ³•

ä»€ä¹ˆæ˜¯åŠ¨æ€è¯­è¨€ï¼Œshow me the code

```ruby
2.7.2 :020 > class Lawyer
2.7.2 :021 > end
 => nil 
2.7.2 :022 > nick = Lawyer.new
 => #<Lawyer:0x00007f8d6bce27f0> 
2.7.2 :023 > nick.talk_simple
Traceback (most recent call last):
        1: from (irb):23
NoMethodError (undefined method `talk_simple' for #<Lawyer:0x00007f8d6bce27f0>)
```

```ruby
2.7.2 :025 > Lawyer.ancestors
 => [Lawyer, ActiveSupport::Dependencies::ZeitwerkIntegration::RequireDependency, ActiveSupport::ForkTracker::CoreExtPrivate, ActiveSupport::ForkTracker::CoreExt, ActiveSupport::ToJsonWithActiveSupportEncoder, Object, JSON::Ext::Generator::GeneratorMethods::Object, ActiveSupport::Dependencies::Loadable, ActiveSupport::Tryable, Kernel, BasicObject] 
```

### è¦†å†™method_missingæ–¹æ³•

```ruby
2.7.2 :026 > class Lawyer
2.7.2 :027 >   def method_missing(method, *args)
2.7.2 :028 >     puts "You called: #{method} (#{args.join(',')})"
2.7.2 :029 >   end
2.7.2 :030 > end
 => :method_missing 
2.7.2 :032 > lawyer = Lawyer.new
 => #<Lawyer:0x00007f8d6be08710> 
2.7.2 :034 > lawyer.send(:talk_simple,2)
You called: talk_simple (2)
```

### å¹½çµæ–¹æ³•

å› ä¸ºè¦è°ƒç”¨çš„æ–¹æ³•å…¶å®ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¹Ÿå«å®ƒå¹½çµæ–¹æ³•ã€‚

## æ¶ˆç­bug

```shell
2.7.2 :121 > class Roulette
2.7.2 :122 >   def method_missing(name, *args)
2.7.2 :123 >     person = name.to_s.capitalize
2.7.2 :124 >     3.times do
2.7.2 :125 >       number = rand(10) + 1
2.7.2 :126 >       puts "#{number}----"
2.7.2 :127 >     end
2.7.2 :128 >     puts  "#{person} got a #{number}"
2.7.2 :129 >   end
2.7.2 :130 > end
```

![image-20210518225149082](/img/Metaprogramming/image-20210518225149082.png)

```shell
2.7.2 :156 > class Roulette
2.7.2 :157 >   def method_missing(name, *args)
2.7.2 :158 >     person = name.to_s.capitalize
2.7.2 :159 >     super unless %w[Bob Tim Longbiu].include? p
erson
2.7.2 :160 >     number = 0
2.7.2 :161 >     3.times do
2.7.2 :162 >       number = rand(10) +1
2.7.2 :163 >       puts "#{number}---"
2.7.2 :164 >     end
2.7.2 :165 >     "#{person} got a #{number}"
2.7.2 :166 >   end
2.7.2 :167 > end
```

##  ç™½æ¿ç±»

è°ƒç”¨ç±»çš„æŸä¸ªæ–¹æ³•è¿”å›nilæ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ¡è¯­å¥åˆ—å‡ºObjectä¸­æ‰€æœ‰ä»¥då¼€å¤´çš„å®ä¾‹æ–¹æ³•

```
Object.instance_methods.grep /^d/
```

### BasicObject

ç»§æ‰¿BasicObjectç±»æ˜¯æœ€ç®€å•çš„å®šä¹‰ç™½æ¿ç±»çš„æ–¹æ³•ã€‚

### åˆ é™¤æ–¹æ³•

| name          | ä½œç”¨                         |
| ------------- | ---------------------------- |
| undef_method  | åˆ é™¤æ‰€æœ‰ï¼ˆåŒ…æ‹¬ç»§æ‰¿æ¥çš„ï¼‰æ–¹æ³• |
| remove_method | ä»…åˆ é™¤æ¥å—è€…è‡ªå·±çš„æ–¹æ³•       |

### ä¿®æ”¹Computer

```ruby
class Computer < BasicObject
	â€¦â€¦
```

## å°ç»“

å¹½çµæ–¹æ³•äº§ç”Ÿé£é™©çš„æ ¹æœ¬åŸå› æ˜¯å®ƒä»¬å¹¶éçœŸæ­£çš„æ–¹æ³•ï¼Œå®ƒä»¬åªæ˜¯å¯¹æ–¹æ³•è°ƒç”¨çš„æ‹¦æˆªã€‚

æœ‰åŠ¨æ€æ–¹æ³•åˆ™æ˜¯æ™®é€šçš„æ–¹æ³•ï¼Œä¸è¿‡å®ƒä»¬ä¸æ˜¯ç”¨defå®šä¹‰ï¼Œè€Œæ˜¯ç”¨define_methodå®šä¹‰ï¼Œå®ƒä»¬çš„è¡Œä¸ºè·Ÿå…¶ä»–æ–¹æ³•æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚

# ä»£ç å—

å—å¯ä»¥ç”¨æ¥æ§åˆ¶**ä½œç”¨åŸŸ(scope)**,ä½œç”¨åŸŸæ˜¯å˜é‡å’Œæ–¹æ³•å¯ç”¨æ€§èŒƒå›´ã€‚

## å­¦ä¹ ä»£ç å—

### ä»£ç å—å­¦ä¹ è·¯çº¿

- ä»£ç å—çš„åŸºç¡€çŸ¥è¯†
- ä½œç”¨åŸŸçš„åŸºç¡€çŸ¥è¯†ï¼šç”¨ä»£ç å—æºå¸¦å˜é‡ç©¿è¶Šä½œç”¨åŸŸ
- é€šè¿‡ä¼ é€’å—ç»™instance_evalæ–¹æ³•æ¥æ§åˆ¶ä½œç”¨åŸŸ
- æ€æ ·æŠŠå—è½¬æ¢ä¸ºè¯¸å¦‚Procå’Œlambdaè¿™æ ·çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œä¾›ä»¥åè°ƒç”¨

### ä»£ç å—åŸºç¡€çŸ¥è¯†

```ruby
def a_method(a,b)
	a+yield(a,b)
end
```

```shell
2.7.2 :103 > def a_method(a,b)
2.7.2 :104 >   a+yield(a,b)
2.7.2 :105 > end
 => :a_method 
2.7.2 :106 > a_method(1,2) {|x,y| (x+y)*3}
 => 10 
```

ä»£ç å—å¯ä»¥ç”¨å¤§æ‹¬å·å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ç”¨doâ€¦â€¦endå…³é”®å­—å®šä¹‰ï¼Œé€šå¸¸æ¥è¯´ï¼Œåªæœ‰ä¸€è¡Œçš„å—ç”¨å¤§æ‹¬å·ï¼Œè€Œå¤šè¡Œçš„å—ç”¨doâ€¦â€¦endã€‚

åªæœ‰è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œæ‰å¯ä»¥å®šä¹‰ä¸€ä¸ªå—ã€‚å—ä¼šè¢«ç›´æ¥ä¼ é€’ç»™è¿™ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥ç”¨yieldå…³é”®å­—è°ƒç”¨è¿™ä¸ªå—ã€‚

**ä½¿ç”¨Kernel#block_given?æ–¹æ³•è¯¢é—®å½“å‰çš„æ–¹æ³•è°ƒç”¨æ˜¯å¦åŒ…å«å—**

```shell
2.7.2 :107 > def a_method
2.7.2 :108 >   return yield if block_given?
2.7.2 :109 >   'no block'
2.7.2 :110 > end
 => :a_method 
2.7.2 :111 > a_method
 => "no block" 
2.7.2 :112 > a_method { "here is a block" }
 => "here is a block" 
```

## ~~Rubyçš„#ç¬¦å·~~

### ~~usingå…³é”®å­—~~

## ä»£ç å—æ˜¯é—­åŒ…

ä»£ç å—è¿˜å¯ä»¥æŠŠå˜é‡å·å·å¸¦å‡ºåŸæ¥çš„ä½œç”¨åŸŸã€‚

ä»£ç å—ä¸èƒ½ç‹¬ç«‹çš„è¿è¡Œã€‚![screenshot-20210521-170353](/img/Metaprogramming/screenshot-20210521-170353.png)

```shell
2.7.2 :128 > def my_method
2.7.2 :129 >   x = "goodbye"
2.7.2 :130 >   yield("cruel")
2.7.2 :131 > end
 => :my_method 
2.7.2 :132 > x = "hello"
 => "hello" 
2.7.2 :133 > my_method { |y| "#{x}, #{y} world" }
 => "hello, cruel world" 
2.7.2 :134 > my_method { |x| "#{x}, world" }
 => "cruel, world" 
```

ç»‘å®šåœ¨ä»£ç å—é‡Œçš„å˜é‡åœ¨ä»£ç å—ç»“æŸä¹‹åï¼Œä¹Ÿè·Ÿç€ç»“æŸäº†ã€‚åŸºäºè¿™æ ·çš„ç‰¹æ€§ï¼Œä»£ç å—ä¹Ÿå«åšé—­åŒ…â€”â€”closureã€‚

### ä½œç”¨åŸŸ

**æ­¤ä¹¦é‡Œä¸€æ®µå¾ˆé­”å¹»çš„è¯**

```tex
è®¾æƒ³ä½ æ˜¯ä¸€ä¸ªå¾®å‹è°ƒè¯•å™¨ï¼ˆdebuggerï¼‰ ï¼Œæ­£æ²¿ç€ä»£ç ç©¿è¿‡ä¸€æ®µRubyç¨‹åºã€‚ä½ ä»ä¸€æ¡è¯­å¥è¹¦åˆ°å¦ä¸€æ¡è¯­å¥ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªæ–­ç‚¹ã€‚çœ‹çœ‹å‘¨å›´çš„ç¯å¢ƒï¼Œè¿™å°±æ˜¯ä½ çš„ä½œç”¨åŸŸã€‚

ä½œç”¨åŸŸé‡Œåˆ°å¤„éƒ½æ˜¯ç»‘å®šã€‚ä½ çš„è„šä¸‹æœ‰ä¸€å †å±€éƒ¨å˜é‡ã€‚æŠ¬å¤´å‘ä¸Šçœ‹ï¼Œä½ ä¼šå‘ç°è‡ªå·±ç«™åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œï¼Œå®ƒæœ‰è‡ªå·±çš„æ–¹æ³•å’Œå®ä¾‹å˜é‡ã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯å½“å‰å¯¹è±¡ï¼Œä¹Ÿç§°ä¸ºselfã€‚ä¸è¿œå¤„æœ‰ä¸€æ£µæŒ‚æ»¡å¸¸é‡çš„æ ‘ï¼Œä½ å¯ä»¥ç”¨å®ƒä»¬æ¥ç¡®å®šè‡ªå·±çš„ä½ç½®ã€‚æ›´è¿œçš„åœ°æ–¹ï¼Œè¿˜æœ‰ä¸€ç»„å…¨å±€å˜é‡ã€‚
```

**Rubyçš„ä½œç”¨åŸŸä¹‹é—´æ˜¯æˆªç„¶åˆ†å¼€çš„ï¼Œä¸€æ—¦è¿›å…¥ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼ŒåŸå…ˆçš„ç»‘å®šä¼šè¢«æ›¿æ¢æˆä¸€ç»„æ–°çš„ç»‘å®šã€‚**

```shell
2.7.2 :149 > def a_scope
2.7.2 :150 >   $var = "some value"
2.7.2 :151 > end
 => :a_scope 
2.7.2 :152 > def another_scope
2.7.2 :153 >   $var
2.7.2 :154 > end
 => :another_scope 
2.7.2 :155 > a_scope
 => "some value" 
2.7.2 :156 > another_scope
 => "some value" 
```

ä»»ä½•äººéƒ½å¯ä»¥ä¿®æ”¹å…¨å±€å˜é‡ï¼Œå¼€å‘è€…å‡ ä¹æ— æ³•ç¡®å®šæ˜¯è°ä¿®æ”¹äº†å®ƒä»¬ã€‚æ‰€ä»¥å°½é‡ä¸ç”¨$å…¨å±€å˜é‡ã€‚æœ‰æ—¶é¡¶çº§å®ä¾‹å˜é‡ä»£æ›¿å…¨å±€å˜é‡ã€‚

### ä½œç”¨åŸŸé—¨

ç¨‹åºä¼šåœ¨ä¸‰ä¸ªåœ°æ–¹å…³é—­å‰ä¸€ä¸ªä½œç”¨åŸŸï¼ŒåŒæ—¶æ‰“å¼€ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼š

- ç±»å®šä¹‰
- æ¨¡å—å®šä¹‰
- æ–¹æ³•

æˆ‘ä»¬å¯ä»¥è¿™æ ·è¯´ï¼šclassï¼Œmoduleï¼Œdefå…³é”®å­—éƒ½å¯¹åº”ä¸€ä¸ªä½œç”¨åŸŸé—¨ã€‚

### æ‰å¹³åŒ–ä½œç”¨åŸŸ

**ä½¿ç”¨Class.newå’Œdefine_methodæ¥ç©¿è¶Šä½œç”¨åŸŸé—¨**

```shell
2.7.2 :170 > my_var = "Success"
 => "Success" 
2.7.2 :163 > MyClass = Class.new do
2.7.2 :164 >   puts "#{my_var} in the class definition!"
2.7.2 :165 >   define_method :my_method do
2.7.2 :166 >   "# {my_var} in the method"
2.7.2 :167 >   end
2.7.2 :168 > end
Success in the class definition!
(irb):163: warning: already initialized constant MyClass
(irb):158: warning: previous definition of MyClass was here
 => MyClass 
```

**å…±äº«ä½œç”¨åŸŸ**

### é—­åŒ…å°ç»“

æ¯ä¸ªRubyä½œç”¨åŸŸéƒ½åŒ…å«ä¸€ç»„ç»‘å®šï¼Œä¸åŒä½œç”¨åŸŸä¹‹é—´è¢«ä½œç”¨åŸŸé—¨åˆ†éš”å¼€æ¥ã€‚

â€¦â€¦

## instance_evalæ–¹æ³•

è¿™æ˜¯å¦å¤–ä¸€ç§æ··åˆä»£ç å’Œç»‘å®šçš„æ–¹å¼ã€‚

```shell
2.7.2 :214 > class MyClass
2.7.2 :215 >   def initialize
2.7.2 :216 >     @v = 1
2.7.2 :217 >   end
2.7.2 :218 > end
 => :initialize 
2.7.2 :219 > obj = MyClass.new
 => #<MyClass:0x00007f8fa39d4380 @v=1> 
2.7.2 :220 > obj.instance_eval do
2.7.2 :221 >   self
2.7.2 :222 >   @v
2.7.2 :223 > end
 => 1 
2.7.2 :224 > v = 2
 => 2 
2.7.2 :225 > obj.instance_eval { @v = v }
 => 2 
2.7.2 :226 > obj.instance_eval { @v}
 => 2 
```

æˆ‘ä»¬æŠŠä¼ é€’ç»™instance_evalæ–¹æ³•çš„ä»£ç å—ç§°ä¸º**ä¸Šä¸‹æ–‡æ¢é’ˆ**ï¼Œå› ä¸ºå®ƒå°±åƒæ˜¯ä¸€ä¸ªæ·±å…¥åˆ°å¯¹è±¡ä¸­çš„ä»£ç ç‰‡æ®µï¼Œå¹¶å¯ä»¥å¯¹é‚£ä¸ªå¯¹è±¡è¿›è¡Œæ“ä½œã€‚

### æ‰“ç ´å°è£…

Instance_execæ–¹æ³•ç¨å¾®çµæ´»ä¸€äº›ï¼Œå…è®¸å¯¹ä»£ç å—ä¼ å…¥å‚æ•°ã€‚

```shell
2.7.2 :256 > class C
2.7.2 :257 >   def initialize
2.7.2 :258 >     @x=1
2.7.2 :259 >   end
2.7.2 :260 > end
 => :initialize 
2.7.2 :261 > class D
2.7.2 :262 >   def twisted_method
2.7.2 :263 >     @y = 2
2.7.2 :264 >     C.new.instance_eval { "@x: #{@x}, @y: #{@y}" }
2.7.2 :265 >   end
2.7.2 :266 > end
 => :twisted_method 
2.7.2 :267 > D.new.twisted_method
 => "@x: 1, @y: " 
```

**å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼šinstance_evalæ–¹æ³•æŠŠreceiverå˜æˆå½“å‰å¯¹è±¡selfæ—¶ï¼Œè°ƒç”¨è€…çš„å®ä¾‹å˜é‡å°±è½åœ¨äº†ä½œç”¨åŸŸèŒƒå›´å¤–é¢ã€‚**

***Instance_execæ–¹æ³•å¯ä»¥è§£å†³æ­¤é—®é¢˜***

```shell
2.7.2 :275 > class D
2.7.2 :276 >   def twisted_method
2.7.2 :277 >     @y = 2
2.7.2 :278 >     C.new.instance_exec(@y) {|y| "@x: #{@x}, @y: #{y}" }
2.7.2 :279 >   end
2.7.2 :280 > end
 => :twisted_method 
2.7.2 :281 > D.new.twisted_method
 => "@x: 1, @y: 2" 
```

### æ´å‡€å®¤

æ´å‡€å®¤åªæ˜¯ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå—çš„ç¯å¢ƒã€‚å®ƒå¯ä»¥æä¾›è‹¥å¹²æœ‰ç”¨çš„æ–¹æ³•ä¾›ä»£ç å—è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ªç†æƒ³åŒ–çš„æ´å‡€å®¤æ˜¯ä¸åº”è¯¥æœ‰ä»»ä½•æ–¹æ³•æˆ–è€…å®ä¾‹å˜é‡çš„ã€‚å› ä¸ºè¿™æ ·çš„è¯ï¼Œå…¶ä¸­çš„æ–¹æ³•åæˆ–å®ä¾‹å˜é‡åæœ‰å¯èƒ½å’Œä»£ç å—ä»å…¶ç¯å¢ƒä¸­å¸¦æ¥çš„åå­—å†²çªã€‚

å› æ­¤ï¼ŒBasicObjectçš„å®ä¾‹å¾€å¾€ç”¨æ¥å……å½“æ´å‡€å®¤ï¼Œ**å› ä¸ºå®ƒæ˜¯ç™½æ¿ç±»**ï¼Œå‡ ä¹æ²¡æœ‰ä»»ä½•æ–¹æ³•ã€‚

## å¯è°ƒç”¨å¯¹è±¡

ä»åº•å±‚çœ‹ï¼Œä½¿ç”¨ä»£ç å—çš„ä¸¤æ­¥ï¼š

- å°†ä»£ç æ‰“åŒ…å¤‡ç”¨
- è°ƒç”¨ä»£ç å—ï¼Œæ‰§è¡Œä»£ç 

è¿™ç§æ‰“åŒ…ä»£ç ï¼Œä¹‹åè°ƒç”¨çš„æœºåˆ¶ä¸»è¦æœ‰ï¼š

- ä½¿ç”¨procï¼Œprocæ˜¯ç”±å—è½¬æ¢è€Œæ¥çš„å¯¹è±¡
- ä½¿ç”¨lambdaï¼Œå®ƒæ˜¯procçš„å˜ç§
- ä½¿ç”¨æ–¹æ³•

### Procå¯¹è±¡

Rubyä¸­çš„ç»å¤§å¤šæ•°ä¸œè¥¿éƒ½æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯ä»£ç å—ä¸æ˜¯ã€‚é‚£ä¹ˆæƒ³å­˜å‚¨ä¸€ä¸ªå—ä¾›ä»¥åæ‰§è¡Œåˆ™éœ€è¦ä¸€ä¸ªå¯¹è±¡ã€‚

Rubyåœ¨æ ‡å‡†åº“ä¸­æä¾›äº†ä¸€ä¸ªåä¸ºprocçš„ç±»ã€‚procå°±æ˜¯ç”±å—è½¬æ¢è€Œæ¥çš„å¯¹è±¡ã€‚

å¼€å‘è€…å¯ä»¥æŠŠä»£ç å—ä¼ ç»™Proc.newæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªprocï¼Œå¹¶ä½¿ç”¨Proc#callæ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªç”±ä»£ç å—è½¬æ¢è€Œæ¥çš„å¯¹è±¡â€”â€”å»¶è¿Ÿæ‰§è¡Œ

```shell
2.7.2 :002 > inc  = Proc.new { |x| x+1}
 => #<Proc:0x00007fde808a7620 (irb):2> 
2.7.2 :003 > inc.call(2)
 => 3 
```

```shell
2.7.2 :004 > dec = lambda { |x| x-1 }
 => #<Proc:0x00007fde8087c100 (irb):4 (lambda)> 
2.7.2 :005 > dec.class
 => Proc 
2.7.2 :006 > dec.call(2)
 => 1 
```

*p = ->(x) {x+1}***ç­‰ä»·äº***p=lambda{|x| x+1}*

**ä½¿ç”¨&å¯ä»¥å®ç°Procå’Œä»£ç å—çš„äº’ç›¸è½¬æ¢**

```shell
2.7.2 :010 > p = my_method{|name| "hello #{name}"}
 => #<Proc:0x00007fde7aba5c38 (irb):10> 
2.7.2 :011 > p.class
 => Proc 
2.7.2 :012 > p.call("Bill")
 => "hello Bill" 
```

```shell
2.7.2 :013 > def my_method(greeting)
2.7.2 :014 >   "#{greeting}, #{yield}"
2.7.2 :015 > end
 => :my_method 
2.7.2 :017 > my_proc = proc{"Bill"}
 => #<Proc:0x00007fde80c98310 (irb):17> 
2.7.2 :018 > my_method("hello",&my_proc)
 => "hello, Bill" 
```

è°ƒç”¨å¦‚ä¸Šçš„my_methodæ–¹æ³•æ—¶ï¼Œ&æ“ä½œç¬¦ä¼šæŠŠmy_procè½¬æ¢ä¸ºä»£ç å—ï¼Œå†æŠŠä»£ç å—ä¼ ç»™è¿™ä¸ªæ–¹æ³•ã€‚

### Procä¸Lambdaçš„å¯¹æ¯”

**ä½¿ç”¨Proc#lambdaï¼Ÿæ–¹æ³•æ£€æµ‹Procæ˜¯ä¸æ˜¯lambda**

Procå’Œlambdaçš„é‡è¦å·®åˆ«æœ‰ä¸¤ä¸ªï¼š

- returnå…³é”®å­—
- å‚æ•°æ ¡éªŒ

lambdaä¸­ï¼Œreturnä»…è¡¨ç¤ºä»è¿™ä¸ªlambdaä¸­è¿”å›

procä¸­ï¼Œreturnè¡¨ç¤ºä»å®šä¹‰procçš„ä½œç”¨åŸŸä¸­è¿”å›

```shell
2.7.2 :034 > p = Proc.new { |a,b| [a,b]}
 => #<Proc:0x00007fde80c60910 (irb):34> 
2.7.2 :035 > p.arity
 => 2 
2.7.2 :036 > p.call(1,2,3)
 => [1, 2] 
2.7.2 :037 > p.call(1)
 => [1, nil] 
```

ç®€å•è¯´ï¼šprocä¼šæŠŠä¼ æ¥çš„å‚æ•°è°ƒæ•´æˆè‡ªå·±æœŸæœ›çš„å½¢å¼ï¼Œè€Œlambdaå‡å¦‚å’Œè‡ªå·±æ‰€æœŸæœ›çš„å½¢å¼ä¸åŒï¼Œåˆ™æŠ›å‡ºé”™è¯¯ã€‚

æ•´ä½“æ¥è¯´ï¼šlambdaæ›´ç›´è§‚ï¼Œå› ä¸ºå®ƒæ›´åƒæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒå¯¹å‚æ•°æ•°é‡è¦æ±‚ä¸¥æ ¼ï¼Œè€Œä¸”è°ƒç”¨returnæ—¶ä»…ä»ä»£ç ä¸­è¿”å›ã€‚

### Methodå¯¹è±¡

```shell
2.7.2 :038 > class MyClass
2.7.2 :039 >   def initialize(value)
2.7.2 :040 >     @x=value
2.7.2 :041 >   end
2.7.2 :042 >   def my_method
2.7.2 :043 >     @x
2.7.2 :044 >   end
2.7.2 :045 > end
 => :my_method 
2.7.2 :046 > object = MyClass.new(1)
 => #<MyClass:0x00007fde7b071a50 @x=1> 
2.7.2 :048 > m = object.method :my_method
 => #<Method: MyClass#my_method() (irb):42> 
2.7.2 :049 > m.call
 => 1 
```

**é€šè¿‡è°ƒç”¨Kernel#methodæ–¹æ³•ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ªç”¨Methodå¯¹è±¡è¡¨ç¤ºçš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä»¥åä½¿ç”¨Method#callæ–¹æ³•å¯¹å®ƒè¿›è¡Œè°ƒç”¨ã€‚**

Methodå¯¹è±¡ç±»ä¼¼ä»£ç å—æˆ–è€…lambdaï¼Œå®é™…ä¸Šï¼Œå¯ä»¥é€šè¿‡Method#to_procæ–¹æ³•æŠŠMethodå¯¹è±¡è½¬æ¢ä¸ºProcã€‚å¦å¤–è¿˜å¯ä»¥é€šè¿‡define_methodæ–¹æ³•æŠŠä»£ç å—è½¬æ¢ä¸ºæ–¹æ³•ã€‚

### å¯è°ƒç”¨å¯¹è±¡å°ç»“

å¯è°ƒç”¨å¯¹è±¡æ˜¯å¯ä»¥æ‰§è¡Œçš„ä»£ç ç‰‡æ®µï¼Œæœ‰ä»¥ä¸‹å‡ ç§ï¼š

- ä»£ç å—ï¼ˆå®ƒä»¬ä¸æ˜¯çœŸæ­£çš„â€œå¯¹è±¡â€ ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯â€œå¯è°ƒç”¨çš„â€ ï¼‰ï¼šåœ¨å®šä¹‰å®ƒä»¬çš„ä½œç”¨åŸŸä¸­æ‰§è¡Œã€‚
- procï¼š Procç±»çš„å¯¹è±¡è·Ÿä»£ç å—ä¸€æ ·ï¼Œä¹Ÿåœ¨å®šä¹‰è‡ªèº«çš„ä½œç”¨åŸŸä¸­æ‰§è¡Œã€‚
- lambdaï¼šä¹Ÿæ˜¯Procç±»çš„å¯¹è±¡ï¼Œä½†æ˜¯è·Ÿæ™®é€šçš„procæœ‰ç»†å¾®çš„å·®åˆ«ã€‚å®ƒè·Ÿå—å’Œprocä¸€æ ·éƒ½æ˜¯é—­åŒ…ï¼Œå› æ­¤ä¹Ÿåœ¨å®šä¹‰è‡ªèº«çš„ä½œç”¨åŸŸä¸­æ‰§è¡Œã€‚
- æ–¹æ³•ï¼šç»‘å®šäºä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æ‰€ç»‘å®šå¯¹è±¡çš„ä½œç”¨åŸŸä¸­æ‰§è¡Œã€‚å®ƒä»¬ä¹Ÿå¯ä»¥ä¸è¿™ä¸ªä½œç”¨åŸŸè§£é™¤ç»‘å®šï¼Œç„¶åå†é‡æ–°ç»‘å®šåˆ°å¦ä¸€ä¸ªå¯¹è±¡çš„ä½œç”¨åŸŸä¸Šã€‚

## ç¼–å†™é¢†åŸŸä¸“å±è¯­è¨€(DSL)

### ç¬¬ä¸€ä¸ªé¢†åŸŸä¸“å±è¯­è¨€

## æ”¹è‰¯çš„DSL

## å°ç»“

# ç±»å®šä¹‰

**å®šä¹‰RUbyç±»å®é™…ä¸Šæ˜¯åœ¨è¿è¡Œä»£ç **

**å®ç±»å¯ä»¥ç”¨æ¥ä¿®æ”¹ç±»**

**ç¯ç»•åˆ«åå¯ä»¥åœ¨å…¶ä»–æ–¹æ³•å‰åå°è£…é¢å¤–ä»£ç **

Rubyæœ€ä¼˜é›…çš„ç‰¹æ€§ä¹‹ä¸€ï¼š**å•ä½“ç±»**

## æ­ç§˜ç±»å®šä¹‰

### æ·±å…¥ç±»å®šä¹‰

```shell
2.7.2 :061 > class MyClass
2.7.2 :062 >   puts "hello"
2.7.2 :063 > end
hello
 => nil 
2.7.2 :064 > result = class MyClass
2.7.2 :065 >   self
2.7.2 :066 > end
 => MyClass 
2.7.2 :067 > result
 => MyClass 
```

### å½“å‰ç±»

ä¸ç®¡å¤„åœ¨Rubyç¨‹åºçš„å“ªä¸ªä½ç½®ï¼Œæ€»å­˜åœ¨ä¸€ä¸ªå½“å‰å¯¹è±¡ï¼šselfã€‚åŒæ ·ä¹Ÿçºµä½¿æœ‰ä¸€ä¸ªå½“å‰ç±»ï¼ˆæˆ–æ¨¡å—ï¼‰å­˜åœ¨ã€‚

**class_evalæ–¹æ³•**

class_evalæ–¹æ³•ä¼šåœ¨ä¸€ä¸ªå·²å­˜åœ¨ç±»çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä¸€ä¸ªå—ã€‚

class_evalä¼šåŒæ—¶ä¿®æ”¹selfå’Œå½“å‰ç±»

- Rubyè§£é‡Šå™¨æ€»æ˜¯è¿½è¸ªå½“å‰ç±»ï¼ˆæˆ–æ¨¡å—ï¼‰çš„å¼•ç”¨ã€‚æ‰€æœ‰ä½¿ç”¨defå®šä¹‰çš„æ–¹æ³•éƒ½æˆä¸ºå½“å‰ç±»çš„å®ä¾‹æ–¹æ³•ã€‚

- åœ¨ç±»å®šä¹‰ä¸­ï¼Œå½“å‰ç±»å°±æ˜¯selfâ€”æ­£åœ¨å®šä¹‰çš„ç±»ã€‚

- å¦‚æœä½ æœ‰ä¸€ä¸ªç±»çš„å¼•ç”¨ï¼Œåˆ™å¯ä»¥ç”¨class_eval ï¼ˆæˆ–moduleâ€”evalï¼‰æ–¹æ³•æ‰“å¼€è¿™ä¸ªç±»ã€‚

### ç±»å®ä¾‹å˜é‡

Rubyè§£é‡Šå™¨å‡å®šæ‰€æœ‰çš„å®ä¾‹å˜é‡éƒ½å±äºå½“å‰å¯¹è±¡selfï¼Œåœ¨ç±»å®šä¹‰æ—¶ä¹Ÿå¦‚æ­¤ï¼

```shell
irb(main):002:1* class MyClass
irb(main):003:1*   @my_var = 1
irb(main):004:2*   def self.read;
irb(main):005:2*     @my_var;
irb(main):006:1*   end
irb(main):007:2*   def write;
irb(main):008:2*     @my_var = 2;
irb(main):009:1*   end
irb(main):010:2*   def read;
irb(main):011:2*     @my_var;
irb(main):012:1*   end
irb(main):013:0> end
=> :read
irb(main):014:0> obj = MyClass.new
irb(main):015:0> obj.read
=> nil
irb(main):016:0> obj.write
=> 2
irb(main):017:0> obj.read
=> 2
irb(main):018:0> MyClass.read
=> 1
```

å…¶ä¸­ä¸€ä¸ª@my_varå˜é‡å®šä¹‰äºobjå……å½“selfçš„æ—¶åˆ»ï¼Œå®ƒæ˜¯objå¯¹è±¡çš„å®ä¾‹å˜é‡ã€‚

å¦å¤–ä¸€ä¸ª@my_varå˜é‡å®šä¹‰äºMyClasså……å½“selfçš„æ—¶åˆ»ï¼Œå®ƒæ˜¯MyClassçš„å®ä¾‹å˜é‡ï¼Œä¹Ÿå°±æ˜¯**ç±»å®ä¾‹å˜é‡**

ä¸€ä¸ªç±»å®ä¾‹å˜é‡åªå¯ä»¥è¢«ç±»æœ¬èº«æ‰€è®¿é—®ï¼Œè€Œä¸èƒ½è¢«ç±»çš„å®ä¾‹æˆ–è€…å­ç±»æ‰€è®¿é—®ã€‚

## Tabooç±»

## å•ä»¶æ–¹æ³•

### ä½¿ç”¨å•ä»¶æ–¹æ³•

### ç±»æ–¹æ³•çš„çœŸç›¸

### ç±»å®

## å•ä»¶ç±»

### å•ä»¶æ–¹æ³•çš„ç¥å¥‡ä¹‹å¤„

### æ­ç§˜å•ä»¶ç±»

### è¡¥å……æ–¹æ³•æŸ¥æ‰¾

## æ¨¡å—çš„éº»çƒ¦

## æ–¹æ³•åŒ…è£…å™¨

### æ–¹æ³•åˆ«å

### æ›´å¤šçš„æ–¹æ³•åŒ…è£…å™¨

### è§£å†³Amazonéš¾é¢˜

## æ‰“ç ´æ•°å­¦è§„å¾‹

## å°ç»“

# ç¼–å†™ä»£ç çš„ä»£ç 

## é€šå‘å‘¨æœ«çš„ç¼–ç¨‹ä¹‹è·¯

### è€æ¿çš„ä»»åŠ¡

### å¼€å‘è®¡åˆ’

## Kernel#evalæ–¹æ³•

### REST Clientçš„ä¾‹å­

### ç»‘å®šå¯¹è±¡

### irbçš„ä¾‹å­

### å¯¹æ¯”ä»£ç å­—ç¬¦ä¸²ä¸å—

### evalæ–¹æ³•çš„éº»çƒ¦

## æ ¡éªŒè¿‡çš„å±æ€§(ç¬¬ä¸€æ­¥)

## æ ¡éªŒè¿‡çš„å±æ€§(ç¬¬äºŒæ­¥)

## æ ¡éªŒè¿‡çš„å±æ€§(ç¬¬ä¸‰æ­¥)

## æ ¡éªŒè¿‡çš„å±æ€§(ç¬¬å››æ­¥)

## é’©å­æ–¹æ³•

### æ›´å¤šé’©å­æ–¹æ³•

### VCRçš„ä¾‹å­

## æ ¡éªŒè¿‡çš„å±æ€§(ç¬¬äº”æ­¥)

## å°ç»“

# å°¾å£°

**æ ¹æœ¬æ²¡æœ‰ä»€ä¹ˆå…ƒç¼–ç¨‹ï¼Œä»æ¥åªæœ‰ç¼–ç¨‹è€Œå·²**

# å‡†å¤‡Railsä¹‹æ—…

# Active Recordçš„è®¾è®¡

# Active Supportçš„Concernæ¨¡å—

# alias_method_chainæ–¹æ³•æ²‰æµ®è¡¨

# å±æ€§æ–¹æ³•çš„å‘å±•

# æœ€åçš„æ€è€ƒ

# é™„å½•ï¼ˆæ€è€ƒï¼‰

## include&extendçš„ä½¿ç”¨åœºæ™¯

```ruby

ä½¿ç”¨includeæŠŠä¸€ä¸ªmoduleåŒ…å«åœ¨ä¸€ä¸ªclass||moduleä¸­ï¼Œä½¿ç”¨.ancestorså¯ä»¥å‘ç°ï¼Œincludeè¿›æ¥çš„class||moduleåœ¨ä¸Šé¢,ä¸€èˆ¬ä½¿ç”¨includeæŠŠè‡ªå·±å†™çš„moduleåŒ…å«è¿›æ¥
eg:

irb(main):001:1* module A
irb(main):002:1*   "this is A"
irb(main):003:0> end
=> "this is A"
irb(main):004:1* class B
irb(main):005:1*   include A
irb(main):006:1*   "this is B"
irb(main):007:0> end
=> "this is B"
irb(main):008:0> B.ancestors
=> [B, A, Object, Kernel, BasicObject]

ä½¿ç”¨extend,ç»§æ‰¿å…¶ä»–moduleï¼Œä¸€èˆ¬ä½¿ç”¨extendç»§æ‰¿rubyè‡ªå¸¦çš„module&gemåŒ…çš„module
irb(main):001:1* module A
irb(main):002:1*   "this is A"
irb(main):003:0> end
=> "this is A"
irb(main):004:1* class B
irb(main):005:1*   extend A
irb(main):006:1*   "this is B"
irb(main):007:0> end
=> "this is B"
irb(main):008:0> B.ancestors
=> [B, Object, Kernel, BasicObject]

```



## åŠ¨æ€åˆ›å»ºå¯¹è±¡&åŠ¨æ€è°ƒç”¨æ–¹æ³•

```ruby
åŠ¨æ€åˆ›å»ºå¯¹è±¡ï¼Œå·²çŸ¥ï¼Œå¯ä»¥æŠŠæ–¹æ³•ï¼Œç±»çœ‹æˆæ˜¯å¯¹è±¡
æ‰€ä»¥----
1.åŠ¨æ€åˆ›å»ºæ–¹æ³•----define_method
ä¸€èˆ¬ä¼šä½¿ç”¨define_methodç»“åˆmethod_missingæ¥ç¼–å†™DRYä»£ç ï¼ä¹Ÿå°±æ˜¯æŠŠé‡å¤çš„ä»£ç å¹²æ‰ï¼

2.7.2 :001 > class Developer
2.7.2 :002 >   
2.7.2 :003 >   def coding_frontend
2.7.2 :004 >     p "writing frontend"
2.7.2 :005 >   end
2.7.2 :006 >   
2.7.2 :007 >   def coding_backend
2.7.2 :008 >     p "writing backend"
2.7.2 :009 >   end
2.7.2 :010 >   
2.7.2 :011 > end
 => :coding_backend 
2.7.2 :012 > developer = Developer.new
 => #<Developer:0x00007f9168453d68> 
2.7.2 :013 > developer.coding_frontend
"writing frontend"
 => "writing frontend" 
2.7.2 :014 > developer.coding_backend
"writing backend"
 => "writing backend" 
2.7.2 :015 > class Developer
2.7.2 :016 >   
2.7.2 :017 >   ["frontend", "backend"].each do |method|
2.7.2 :018 >     define_method "coding_#{method}" do
2.7.2 :019 >     p "writing " + method.to_s
2.7.2 :020 >     end
2.7.2 :021 >   end
2.7.2 :022 >   
2.7.2 :023 > end
 => ["frontend", "backend"] 
2.7.2 :024 > developer = Developer.new
 => #<Developer:0x00007f916c9be178> 
2.7.2 :025 > developer.coding_frontend
"writing frontend"
 => "writing frontend" 
2.7.2 :026 > developer.coding_backend
"writing backend"
 => "writing backend"


2.åŠ¨æ€åˆ›å»ºç±»----class_eval&instance_eval

åŠ¨æ€è°ƒç”¨æ–¹æ³•ï¼Œä½œç”¨æ˜¯å¯ä»¥æ¶ˆé™¤ç¹å¤çš„ä»£ç 
and
è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ç»™ä¸€ä¸ªå¯¹è±¡å‘é€ä¸€æ¡æ¶ˆæ¯ï¼

Calling Methods Dynamically

å¸¸è§„çš„æ“ä½œæ˜¯ä½¿ç”¨ç‚¹æ ‡å¿—ç¬¦(.)

irb(main):001:1* class MyClass
irb(main):002:2*   def my_method(my_arg)
irb(main):003:2*     my_arg * 2
irb(main):004:1*   end
irb(main):005:0> end
=> :my_method
irb(main):006:0> obj = MyClass.new
irb(main):007:0> obj.my_method(3)
=> 6
irb(main):009:0> obj.send(:my_method,3)
=> 6

åœ¨sendæ–¹æ³•ä¸­ï¼Œæƒ³è°ƒç”¨çš„æ–¹æ³•å˜æˆäº†å‚æ•°ï¼Œå¯ä»¥åŠ¨æ€æ´¾å‘ï¼

å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨åŠ¨æ€è°ƒç”¨æ–¹æ³•ä¸­ï¼Œæ–¹æ³•æ˜¯ä»¥Symbolçš„å½¢å¼ä½œä¸ºå‚æ•°çš„ï¼Œå› ä¸ºSymbolæ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œæ‰€ä»¥å°†æ–¹æ³•åè¡¨ç¤ºä¸ºSymbolï¼Œand  StringåŒæ ·ä¹Ÿå¯ä»¥ä½œä¸ºæ–¹æ³•çš„å‚æ•°ï¼

last but not least ----

.sendç”šè‡³å¯ä»¥è°ƒç”¨ç§æœ‰æ–¹æ³•ï¼Œå‡å¦‚ä¸æƒ³è¿™ä¹ˆåšï¼Œå¯ä»¥ä½¿ç”¨.public_sendæ–¹æ³•ï¼ï¼ï¼

```



## åŠ¨æ€æ‰§è¡Œè„šæœ¬

```ruby

# eval
ä»£ç æ‰§è¡Œæœ€ç›´æ¥çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æœ€ç›´æ¥çš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨eval
irb(main):009:0> eval("3-1")
=> 2

# instance_eval
å°†æš‚æ—¶çš„å˜åŒ–å¸¦å…¥å¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­

# class_eval(module_eval)
ä¸´æ—¶æ€§çš„è¿›å…¥ç±»å®šä¹‰å—çš„ä¸Šä¸‹æ–‡

```

